<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Set Password Baru — QC Dadap</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="main">
    <div class="container">
      <section class="card">
        <h1>Setel Password Baru</h1>
        <p class="muted" id="hint">Memeriksa token...</p>
        <form id="setPwdForm" class="form" style="display:none">
          <label>Password baru</label>
          <div class="input-with-icon">
            <input type="password" id="rnp1" minlength="6" required />
            <button type="button" class="icon-btn" id="toggle1" aria-label="Tampilkan password">👁️</button>
          </div>

          <div class="muted small mt-1" id="meter">Kekuatan: -</div>

          <label>Ulangi password baru</label>
          <div class="input-with-icon">
            <input type="password" id="rnp2" minlength="6" required />
            <button type="button" class="icon-btn" id="toggle2" aria-label="Tampilkan password">👁️</button>
          </div>

          <button class="btn mt-3" type="submit">Simpan Password</button>
        </form>
      </section>
    </div>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="script-supabase.js"></script>
  <script>
  // Ketika datang lewat link email reset, Supabase mengirim event PASSWORD_RECOVERY
  sb.auth.onAuthStateChange(async (event, session) => {
    if (event === 'PASSWORD_RECOVERY') {
      document.getElementById('hint').textContent = 'Token valid. Silakan masukkan password baru.';
      document.getElementById('setPwdForm').style.display = 'block';
    }
  });

  document.getElementById('setPwdForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const p1 = document.getElementById('rnp1').value.trim();
    const p2 = document.getElementById('rnp2').value.trim();
    const hint = document.getElementById('hint');

    if (p1 !== p2) {
      hint.textContent = 'Password baru dan ulangannya tidak sama.';
      return;
    }

    const { error } = await sb.auth.updateUser({ password: p1 });
    hint.textContent = error ? ('Gagal menyimpan: ' + error.message) : 'Password berhasil diubah. Kamu bisa menutup halaman ini dan login.';
    if (!error) document.getElementById('setPwdForm').reset();
  });
  
  // toggle show/hide
  function bindToggle(btnId, inputId){
    const btn = document.getElementById(btnId);
    const inp = document.getElementById(inputId);
    btn.addEventListener('click', () => {
      const t = inp.getAttribute('type') === 'password' ? 'text' : 'password';
      inp.setAttribute('type', t);
      btn.textContent = t === 'password' ? '👁️' : '🙈';
    });
  }
  bindToggle('toggle1', 'rnp1');
  bindToggle('toggle2', 'rnp2');

  // meter kekuatan sangat sederhana
  const p1 = document.getElementById('rnp1');
  const meter = document.getElementById('meter');
  p1.addEventListener('input', () => {
    const v = p1.value;
    let score = 0;
    if (v.length >= 8) score++;
    if (/[A-Z]/.test(v)) score++;
    if (/[a-z]/.test(v)) score++;
    if (/\d/.test(v)) score++;
    if (/[^A-Za-z0-9]/.test(v)) score++;
    const labels = ['Sangat lemah','Lemah','Cukup','Kuat','Sangat kuat'];
    const cls = ['danger','danger','warn','info','success'][Math.max(0,score-1)];
    meter.innerHTML = `Kekuatan: <span class="badge ${cls}">${labels[Math.max(0,score-1)]}</span>`;
  });
  </script>
</body>
</html>
