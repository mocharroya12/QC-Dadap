<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login — QC Dadap</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('show')">☰ Menu</button>
  <aside class="sidebar">
    <div class="logo">QC Dadap</div>
    <nav>
      <a href="index.html">🏠 Home</a>
      <a href="fitup.html">🔧 Fitup</a>
      <a href="visual-welding.html">🛠️ Visual Welding</a>
      <a href="ndt.html">📡 Non Destructive Test</a>
      <a href="input-data.html">📊 Input Data</a>
      <a href="projects.html">📁 Projects</a>
      <a href="drawing.html">📐 Drawing</a>
      <a href="account.html">⚙️ Akun</a>
      <a href="user-stats.html">👥 Status User</a>
    </nav>
  </aside>

  <main class="main">
    <div class="container">
      <section class="card" style="max-width:520px;margin:auto">
        <h1>🔐 Login</h1>
        <p class="muted">Masuk untuk mengakses halaman QC.</p>

        <form id="loginForm" class="form-grid">
          <div style="grid-column:1 / -1">
            <label>Email</label>
            <input type="text" id="email" autocomplete="username" placeholder="nama@perusahaan.com" required>
          </div>
          <div style="grid-column:1 / -1">
            <label>Kata Sandi</label>
            <input type="password" id="password" autocomplete="current-password" placeholder="••••••••" required>
            <label class="small mt-1"><input type="checkbox" id="showPw"> Tampilkan sandi</label>
          </div>
          <div style="grid-column:1 / -1;display:flex;gap:10px;align-items:center">
            <button class="btn" type="submit">Masuk</button>
            <button class="btn" type="button" id="loginGoogle">Masuk dengan Google</button>
          </div>
          <div style="grid-column:1 / -1" class="small muted mt-2">
            Belum punya akun? <a href="register.html">Daftar</a>.
          </div>
          <div style="grid-column:1 / -1" class="small muted mt-2"></div>
          <div id="msg" class="small muted mt-2">
            <button id="btnForgot" class="btn btn-outline" type="button">Lupa password?</button>
          </div>
        </form>
      </section>
    </div>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="script-supabase.js"></script>
  <script src="auth.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const msg = document.getElementById("msg");

    document.getElementById("showPw").addEventListener("change", (e) => {
      const pw = document.getElementById("password");
      pw.type = e.target.checked ? "text" : "password";
    });

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "Memproses...";
      try{
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        const params = new URLSearchParams(location.search);
        const target = params.get("next") || "index.html";
        location.href = target;
      } catch(err){
        console.error(err);
        msg.textContent = (err?.message || "Login gagal");
        alert("Login gagal: " + (err?.message || ""));
      }
    });

    document.getElementById("loginGoogle").addEventListener("click", async () => {
      try{
        const params = new URLSearchParams(location.search);
        const redirectTo = params.get("next") || location.origin + "/index.html";
        await sb.auth.signInWithOAuth({ provider: "google", options: { redirectTo } });
        ({
          provider: "google",
          options: { redirectTo }
        });
      }catch(err){
        alert("Gagal mulai login Google: " + (err?.message || ""));
      }
    });
  });

  document.getElementById('btnForgot')?.addEventListener('click', async () => {
    const email = prompt('Masukkan email kamu untuk reset password:');
    if (!email) return;
    const { error } = await sb.auth.resetPasswordForEmail(email, {
      redirectTo: location.origin + '/update-password.html'
    });
    alert(error ? ('Gagal kirim link: ' + error.message) : 'Link reset dikirim. Cek email kamu.');
  });
  </script>
</body>
</html>
